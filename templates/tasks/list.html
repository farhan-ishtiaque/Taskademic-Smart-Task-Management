{% extends 'base.html' %}
{% load static %}

{% block title %}All Tasks - Taskademic{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
.task-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.task-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.task-card.priority-must {
    border-left-color: #ef4444;
}

.task-card.priority-should {
    border-left-color: #f59e0b;
}

.task-card.priority-could {
    border-left-color: #10b981;
}

.task-card.priority-wont {
    border-left-color: #6b7280;
}

.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-weight: 500;
}

.status-todo {
    background-color: #dbeafe;
    color: #1e40af;
}

.status-in_progress {
    background-color: #fef3c7;
    color: #d97706;
}

.status-review {
    background-color: #ede9fe;
    color: #7c3aed;
}

.status-done {
    background-color: #dcfce7;
    color: #16a34a;
}

.filter-tabs {
    border-bottom: 1px solid #e5e7eb;
}

.filter-tab {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s;
}

.filter-tab.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
}

.filter-tab:hover {
    background-color: #f9fafb;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="px-4 py-6 sm:px-0">
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">All Tasks</h1>
                    <p class="mt-2 text-gray-600">Manage and track all your tasks</p>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'tasks:create' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>New Task
                    </a>
                    <a href="{% url 'tasks:kanban_board' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-columns mr-2"></i>Kanban View
                    </a>
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="filter-tabs flex">
                <div class="filter-tab active" data-filter="all">
                    All Tasks <span class="ml-1 text-gray-500">({{ tasks.count }})</span>
                </div>
                <div class="filter-tab" data-filter="todo">
                    To Do <span class="ml-1 text-gray-500">({{ tasks|length }})</span>
                </div>
                <div class="filter-tab" data-filter="in_progress">
                    In Progress
                </div>
                <div class="filter-tab" data-filter="review">
                    Review
                </div>
                <div class="filter-tab" data-filter="done">
                    Done
                </div>
            </div>
        </div>

        <!-- Tasks Grid -->
        <div class="grid gap-4">
            {% for task in tasks %}
                <div class="task-card bg-white rounded-lg shadow-sm p-6 priority-{{ task.priority }}" data-status="{{ task.status }}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <!-- Task Title and Description -->
                            <div class="mb-3">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">{{ task.title }}</h3>
                                {% if task.description %}
                                    <p class="text-gray-600 text-sm">{{ task.description|truncatechars:100 }}</p>
                                {% endif %}
                            </div>

                            <!-- Task Meta Information -->
                            <div class="flex flex-wrap items-center gap-3 text-sm">
                                <!-- Status Badge -->
                                <span class="status-badge status-{{ task.status }}">
                                    {% if task.status == 'todo' %}
                                        <i class="fas fa-circle mr-1"></i>To Do
                                    {% elif task.status == 'in_progress' %}
                                        <i class="fas fa-play mr-1"></i>In Progress
                                    {% elif task.status == 'review' %}
                                        <i class="fas fa-eye mr-1"></i>Review
                                    {% elif task.status == 'done' %}
                                        <i class="fas fa-check mr-1"></i>Done
                                    {% endif %}
                                </span>

                                <!-- Priority Badge -->
                                <span class="px-2 py-1 rounded-full text-xs font-medium
                                    {% if task.priority == 'urgent' or task.priority == 'high' %}bg-red-100 text-red-700
                                    {% elif task.priority == 'medium' %}bg-orange-100 text-orange-700
                                    {% else %}bg-blue-100 text-blue-700{% endif %}">
                                    {% if task.priority == 'urgent' or task.priority == 'high' %}Must Have
                                    {% elif task.priority == 'medium' %}Should Have
                                    {% else %}Could Have{% endif %}
                                </span>

                                <!-- Category -->
                                {% if task.category %}
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                                        {{ task.get_category_display }}
                                    </span>
                                {% endif %}

                                <!-- Due Date -->
                                {% if task.due_date %}
                                    <span class="text-gray-500 flex items-center">
                                        <i class="fas fa-calendar mr-1"></i>
                                        <span class="{% if task.is_overdue %}text-red-600 font-medium{% endif %}">
                                            {{ task.due_date|date:"M d, Y H:i" }}
                                            {% if task.is_overdue %}
                                                <span class="text-red-600 font-medium">(Overdue)</span>
                                            {% endif %}
                                        </span>
                                    </span>
                                {% endif %}

                                <!-- Created Date -->
                                <span class="text-gray-400">
                                    <i class="fas fa-clock mr-1"></i>
                                    Created {{ task.created_at|date:"M d, Y" }}
                                </span>
                            </div>

                            <!-- Tags -->
                            {% if task.tags %}
                                <div class="mt-3">
                                    {% for tag in task.tag_list %}
                                        <span class="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded mr-1 mb-1">
                                            #{{ tag }}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            <!-- Team Assignment -->
                            {% if task.team %}
                                <div class="mt-2 text-sm text-blue-600">
                                    <i class="fas fa-users mr-1"></i>
                                    Team: {{ task.team.name }}
                                    {% if task.assigned_to %}
                                        | Assigned to: {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col space-y-2 ml-4">
                            <a href="{% url 'tasks:edit' task.id %}" 
                               class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition-colors"
                               title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </a>
                            
                            {% if task.status != 'done' %}
                                <button onclick="markTaskComplete({{ task.id }})" 
                                        class="text-green-600 hover:text-green-800 p-2 rounded-full hover:bg-green-50 transition-colors"
                                        title="Mark Complete">
                                    <i class="fas fa-check"></i>
                                </button>
                            {% endif %}
                            
                            <a href="{% url 'tasks:delete' task.id %}" 
                               class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition-colors"
                               title="Delete Task"
                               onclick="return confirm('Are you sure you want to delete this task?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-12">
                    <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-tasks text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks found</h3>
                    <p class="text-gray-500 mb-6">Get started by creating your first task.</p>
                    <a href="{% url 'tasks:create' %}" 
                       class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Create Your First Task
                    </a>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterTabs = document.querySelectorAll('.filter-tab');
    const taskCards = document.querySelectorAll('.task-card');

    filterTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Update active tab
            filterTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            const filter = this.getAttribute('data-filter');

            // Filter tasks
            taskCards.forEach(card => {
                const status = card.getAttribute('data-status');
                
                if (filter === 'all' || status === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
});

// Mark task complete function
function markTaskComplete(taskId) {
    if (confirm('Mark this task as complete?')) {
        fetch(`/tasks/${taskId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ completed: true })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                if (data.message) {
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    successMsg.innerHTML = `<div class="text-sm">${data.message}</div>`;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                }
                location.reload();
            } else {
                alert('Failed to mark task as complete: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to mark task as complete');
        });
    }
}
</script>

{% csrf_token %}
{% endblock %}
