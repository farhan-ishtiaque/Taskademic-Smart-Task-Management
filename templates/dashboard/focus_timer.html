{% extends 'base.html' %}
{% load static %}

{% block title %}Focus Timer - Taskademic{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    * {
        font-family: 'Inter', sans-serif;
    }
    
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    
    .main-container {
        max-width: 1400px;
                 <!-- 5 Small Things -->
                <div class="task-category small-things">
                    <div class="category-header">
                        <div class="category-title">⚡ 5 Small Things</div>
                        <div class="category-count">{{ could_do_tasks|length }}/5</div>
                    </div> margin: 0 auto;
        padding: 2rem;
    }
    
    .page-header {
        text-align: center;
        margin-bottom: 3rem;
        color: white;
    }
    
    .page-title {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .page-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        font-weight: 300;
    }
    
    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }
    
    .glass-box {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        transition: all 0.3s ease;
    }
    
    .glass-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: white;
        margin-bottom: 1.5rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .task-category {
        margin-bottom: 2.5rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.15);
    }
    
    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0;
        background: rgba(255, 255, 255, 0.25);
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .category-title {
        font-weight: 700;
        color: white;
        font-size: 1.2rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .category-count {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .task-item {
        background: white;
        border-radius: 16px;
        padding: 0;
        margin-bottom: 1rem;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }
    
    .task-item:last-child {
        margin-bottom: 1rem;
    }
    
    .task-item:hover {
        border-color: #667eea;
        box-shadow: 0 8px 25px rgba(103, 126, 234, 0.15);
        transform: translateY(-2px);
    }
    
    .task-item:hover .task-checkbox input[type="checkbox"] {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(103, 126, 234, 0.1);
    }
    
    .task-item-inner {
        padding: 2rem;
        display: flex;
        align-items: flex-start;
        gap: 1.5rem;
    }
    
    .checkbox-container {
        position: relative;
        flex-shrink: 0;
    }
    
    .checkbox-container::after {
        content: "";
        position: absolute;
        top: 1rem;
        left: 100%;
        width: 1rem;
        height: 2px;
        background: linear-gradient(to right, #667eea, transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .task-item:hover .checkbox-container::after {
        opacity: 1;
    }
    
    .task-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 1.5rem;
        position: relative;
    }
    
    .task-checkbox input[type="checkbox"] {
        width: 2rem;
        height: 2rem;
        border-radius: 10px;
        border: 3px solid #667eea;
        background: white;
        margin-top: 0.25rem;
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
        transition: all 0.3s ease;
    }
    
    .task-checkbox input[type="checkbox"]:hover {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(103, 126, 234, 0.1);
        transform: scale(1.05);
    }
    
    .task-checkbox input[type="checkbox"]:checked {
        background: #667eea;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(103, 126, 234, 0.2);
    }
    
    .task-checkbox input[type="checkbox"]:checked::after {
        content: "✓";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .task-content {
        flex: 1;
        min-width: 0;
        background: linear-gradient(90deg, rgba(103, 126, 234, 0.02) 0%, transparent 100%);
        padding: 1rem 1.5rem;
        border-radius: 12px;
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
    }
    
    .task-item:hover .task-content {
        background: linear-gradient(90deg, rgba(103, 126, 234, 0.05) 0%, transparent 100%);
        border-left-color: #667eea;
    }
    
    .task-title {
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
        line-height: 1.3;
        cursor: pointer;
    }
    
    .task-description {
        color: #6b7280;
        font-size: 0.95rem;
        line-height: 1.5;
        font-weight: 400;
        cursor: pointer;
    }
    
    /* Visual connection indicators */
    .task-item:hover .task-title {
        color: #4f46e5;
    }
    
    .task-item.completed .task-content {
        opacity: 0.6;
        background: linear-gradient(90deg, rgba(34, 197, 94, 0.05) 0%, transparent 100%);
        border-left-color: #22c55e;
    }
    
    .task-item.completed .task-title {
        text-decoration: line-through;
        color: #6b7280;
    }
    
    .empty-state {
        background: rgba(255, 255, 255, 0.9);
        border: 2px dashed #667eea;
        border-radius: 12px;
        padding: 3rem;
        margin: 1.5rem;
        text-align: center;
        color: #667eea;
    }
    
    .empty-state svg {
        opacity: 0.6;
        margin-bottom: 1rem;
    }
    
    .empty-state p {
        font-weight: 500;
        margin: 0;
        font-size: 1.1rem;
    }
    
    /* Category-specific styling */
    .big-things {
        border-color: rgba(239, 68, 68, 0.4);
    }
    
    .big-things .category-header {
        background: rgba(239, 68, 68, 0.25);
    }
    
    .big-things .category-count {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .medium-things {
        border-color: rgba(245, 158, 11, 0.4);
    }
    
    .medium-things .category-header {
        background: rgba(245, 158, 11, 0.25);
    }
    
    .medium-things .category-count {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .small-things {
        border-color: rgba(34, 197, 94, 0.4);
    }
    
    .small-things .category-header {
        background: rgba(34, 197, 94, 0.25);
    }
    
    .small-things .category-count {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }
        text-align: center;
        color: white;
        opacity: 0.8;
    }
    
    .timer-section {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    
    .timer-setup {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .timer-display {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .timer-clock {
        font-size: 4rem;
        font-weight: 700;
        color: white;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        margin-bottom: 1rem;
    }
    
    .timer-label {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
        margin-bottom: 2rem;
    }
    
    .progress-ring {
        width: 200px;
        height: 200px;
        margin: 0 auto 2rem;
        position: relative;
    }
    
    .progress-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(from 0deg, #3b82f6 0%, #3b82f6 0%, rgba(255, 255, 255, 0.2) 0%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .progress-circle::after {
        content: '';
        width: 160px;
        height: 160px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        backdrop-filter: blur(10px);
    }
    
    .timer-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .control-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }
    
    .control-btn.primary {
        background: #3b82f6;
        border-color: #3b82f6;
    }
    
    .control-btn.primary:hover {
        background: #2563eb;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        color: white;
        font-weight: 600;
        margin-bottom: 0.5rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .form-select {
        width: 100%;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.9);
        color: #1f2937;
        font-weight: 500;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .stat-box {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .stat-label {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .add-task-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }
    
    .add-task-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        color: white;
        text-decoration: none;
    }
    
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
        
        .main-container {
            padding: 1rem;
        }
        
        .page-title {
            font-size: 2rem;
        }
        
        .timer-clock {
            font-size: 3rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="page-header">
        <h1 class="page-title">Focus Timer</h1>
        <p class="page-subtitle">Boost your productivity with the 1-3-5 method and Pomodoro technique</p>
    </div>
    
    <div class="content-grid">
        <!-- Left Column - Task Management -->
        <div class="task-management">
            <a href="{% url 'tasks:create' %}" class="add-task-btn">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add New Task
            </a>
            
            <div class="glass-box">
                <h2 class="section-title">1-3-5 Daily Method</h2>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 2rem;">
                    Focus on 1 big thing, 3 medium things, and 5 small things each day
                </p>
                
                <!-- 1 Big Thing -->
                <div class="task-category big-things">
                    <div class="category-header">
                        <div class="category-title">🎯 1 Big Thing</div>
                        <div class="category-count">{{ must_do_tasks|length }}/1</div>
                    </div>
                    
                    {% for task in must_do_tasks %}
                        <div class="task-item">
                            <div class="task-item-inner">
                                <div class="checkbox-container">
                                    <input type="checkbox" class="task-checkbox-input" id="big-{{ task.id }}" data-task-id="{{ task.id }}" {% if task.status == 'done' %}checked{% endif %}>
                                </div>
                                <div class="task-content">
                                    <div class="task-title">{{ task.title }}</div>
                                    <div class="task-description">{{ task.description|truncatechars:60 }}</div>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="empty-state">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            <p>Choose your most important task for today</p>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- 3 Medium Things -->
                <div class="task-category medium-things">
                    <div class="category-header">
                        <div class="category-title">📋 3 Medium Things</div>
                        <div class="category-count">{{ should_do_tasks|length }}/3</div>
                    </div>
                    
                    {% for task in should_do_tasks %}
                        <div class="task-item">
                            <div class="task-item-inner">
                                <div class="checkbox-container">
                                    <input type="checkbox" class="task-checkbox-input" id="medium-{{ task.id }}" data-task-id="{{ task.id }}" {% if task.status == 'done' %}checked{% endif %}>
                                </div>
                                <div class="task-content">
                                    <div class="task-title">{{ task.title }}</div>
                                    <div class="task-description">{{ task.description|truncatechars:50 }}</div>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="empty-state">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            <p>Select 3 important tasks to accomplish</p>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- 5 Small Things -->
                <div class="task-category">
                    <div class="category-header">
                        <div class="category-title">✅ 5 Small Things</div>
                        <div class="category-count">{{ could_do_tasks|length }}/5</div>
                    </div>
                    
                    {% for task in could_do_tasks %}
                        <div class="task-item">
                            <div class="task-item-inner">
                                <div class="checkbox-container">
                                    <input type="checkbox" class="task-checkbox-input" id="small-{{ task.id }}" data-task-id="{{ task.id }}" {% if task.status == 'done' %}checked{% endif %}>
                                </div>
                                <div class="task-content">
                                    <div class="task-title">{{ task.title }}</div>
                                    <div class="task-description">{{ task.description|truncatechars:40 }}</div>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="empty-state">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <p>Add 5 quick tasks to complete</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Right Column - Timer Section -->
        <div class="timer-section">
            <!-- Timer Setup -->
            <div class="timer-setup">
                <h3 class="section-title" style="font-size: 1.2rem; margin-bottom: 1.5rem;">Timer Setup</h3>
                
                <div class="form-group">
                    <label class="form-label">Select Task</label>
                    <select class="form-select" id="task-selector">
                        <option value="">Choose a task to focus on</option>
                        {% for task in must_do_tasks %}
                            <option value="{{ task.id }}">🎯 {{ task.title }}</option>
                        {% endfor %}
                        {% for task in should_do_tasks %}
                            <option value="{{ task.id }}">📋 {{ task.title }}</option>
                        {% endfor %}
                        {% for task in could_do_tasks %}
                            <option value="{{ task.id }}">✅ {{ task.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Technique</label>
                    <select class="form-select" id="technique-selector">
                        <option value="pomodoro">🍅 Pomodoro (25min/5min)</option>
                        <option value="52-17">⏰ 52/17 (52min/17min)</option>
                        <option value="custom">⚙️ Custom Timer</option>
                    </select>
                </div>
            </div>
            
            <!-- Timer Display -->
            <div class="timer-display">
                <div class="progress-ring">
                    <div class="progress-circle" id="progress-circle">
                        <div class="timer-clock" id="timer-display">25:00</div>
                    </div>
                </div>
                
                <div class="timer-label" id="timer-phase">Ready to focus</div>
                
                <div class="timer-controls">
                    <button class="control-btn primary" id="start-btn" onclick="toggleTimer()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h10a2 2 0 012 2v8a2 2 0 01-2 2H7a2 2 0 01-2-2v-8a2 2 0 012-2z"/>
                        </svg>
                        Start Focus
                    </button>
                    <button class="control-btn" id="reset-btn" onclick="resetTimer()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Reset
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number" id="sessions-count">0</div>
                        <div class="stat-label">Sessions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="total-time">0h</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Enhanced Timer with Visual Effects
    class EnhancedTimer {
        constructor() {
            this.timeLeft = 25 * 60; // 25 minutes in seconds
            this.totalTime = 25 * 60;
            this.isRunning = false;
            this.isBreak = false;
            this.interval = null;
            this.currentTask = null;
            this.sessionsCompleted = 0;
            this.totalFocusTime = 0;
            
            this.techniques = {
                pomodoro: { work: 25, break: 5 },
                '52-17': { work: 52, break: 17 },
                custom: { work: 25, break: 5 }
            };
            
            this.initializeElements();
            this.bindEvents();
            this.loadStats();
        }
        
        initializeElements() {
            this.timerDisplay = document.getElementById('timer-display');
            this.progressCircle = document.getElementById('progress-circle');
            this.timerPhase = document.getElementById('timer-phase');
            this.startBtn = document.getElementById('start-btn');
            this.resetBtn = document.getElementById('reset-btn');
            this.taskSelector = document.getElementById('task-selector');
            this.techniqueSelector = document.getElementById('technique-selector');
            this.sessionsCount = document.getElementById('sessions-count');
            this.totalTimeElement = document.getElementById('total-time');
        }
        
        bindEvents() {
            this.techniqueSelector.addEventListener('change', () => {
                this.updateTechnique();
            });
            
            this.taskSelector.addEventListener('change', () => {
                this.currentTask = this.taskSelector.value;
            });
            
            // Task checkbox events
            document.querySelectorAll('.task-checkbox-input').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    this.updateTaskStatus(e.target.dataset.taskId, e.target.checked);
                });
            });
        }
        
        updateTechnique() {
            const technique = this.techniqueSelector.value;
            const settings = this.techniques[technique];
            
            if (technique === 'custom') {
                // You could add a modal here for custom time settings
                this.timeLeft = 25 * 60;
                this.totalTime = 25 * 60;
            } else {
                this.timeLeft = settings.work * 60;
                this.totalTime = settings.work * 60;
            }
            
            this.isBreak = false;
            this.updateDisplay();
            this.updateProgress();
        }
        
        toggleTimer() {
            if (this.isRunning) {
                this.pauseTimer();
            } else {
                this.startTimer();
            }
        }
        
        startTimer() {
            this.isRunning = true;
            this.startBtn.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6l4-2z"/>
                </svg>
                Pause
            `;
            this.startBtn.classList.add('pause');
            
            this.interval = setInterval(() => {
                this.timeLeft--;
                this.updateDisplay();
                this.updateProgress();
                
                if (this.timeLeft <= 0) {
                    this.completeSession();
                }
            }, 1000);
            
            // Update timer phase
            if (this.isBreak) {
                this.timerPhase.textContent = 'Break Time 🧘‍♀️';
            } else {
                this.timerPhase.textContent = this.currentTask ? 
                    `Focusing on: ${this.getTaskTitle()}` : 'Focus Session 🎯';
            }
        }
        
        pauseTimer() {
            this.isRunning = false;
            clearInterval(this.interval);
            this.startBtn.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h10a2 2 0 012 2v8a2 2 0 01-2-2v-8a2 2 0 012-2z"/>
                </svg>
                Resume
            `;
            this.startBtn.classList.remove('pause');
            this.timerPhase.textContent = 'Paused ⏸️';
        }
        
        resetTimer() {
            this.isRunning = false;
            clearInterval(this.interval);
            
            const technique = this.techniqueSelector.value;
            const settings = this.techniques[technique];
            
            if (this.isBreak) {
                this.timeLeft = (settings.break || 5) * 60;
                this.totalTime = (settings.break || 5) * 60;
            } else {
                this.timeLeft = (settings.work || 25) * 60;
                this.totalTime = (settings.work || 25) * 60;
            }
            
            this.updateDisplay();
            this.updateProgress();
            
            this.startBtn.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h10a2 2 0 012 2v8a2 2 0 01-2-2v-8a2 2 0 012-2z"/>
                </svg>
                Start Focus
            `;
            this.startBtn.classList.remove('pause');
            this.timerPhase.textContent = 'Ready to focus';
        }
        
        completeSession() {
            this.isRunning = false;
            clearInterval(this.interval);
            
            if (!this.isBreak) {
                // Focus session completed
                this.sessionsCompleted++;
                this.totalFocusTime += this.totalTime;
                this.saveStats();
                this.updateStatsDisplay();
                
                // Show notification
                this.showNotification('🎉 Focus session completed!', 'Time for a break');
                
                // Switch to break
                this.switchToBreak();
            } else {
                // Break completed
                this.showNotification('Break over!', 'Ready for another focus session?');
                this.switchToFocus();
            }
        }
        
        switchToBreak() {
            this.isBreak = true;
            const technique = this.techniqueSelector.value;
            const settings = this.techniques[technique];
            
            this.timeLeft = (settings.break || 5) * 60;
            this.totalTime = (settings.break || 5) * 60;
            this.timerPhase.textContent = 'Break Time 🧘‍♀️';
            
            this.updateDisplay();
            this.updateProgress();
            
            // Auto-start break timer
            this.startTimer();
        }
        
        switchToFocus() {
            this.isBreak = false;
            const technique = this.techniqueSelector.value;
            const settings = this.techniques[technique];
            
            this.timeLeft = (settings.work || 25) * 60;
            this.totalTime = (settings.work || 25) * 60;
            this.timerPhase.textContent = 'Ready to focus';
            
            this.updateDisplay();
            this.updateProgress();
            
            this.startBtn.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h10a2 2 0 012 2v8a2 2 0 01-2-2v-8a2 2 0 012-2z"/>
                </svg>
                Start Focus
            `;
            this.startBtn.classList.remove('pause');
        }
        
        updateDisplay() {
            const minutes = Math.floor(this.timeLeft / 60);
            const seconds = this.timeLeft % 60;
            this.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        updateProgress() {
            const progress = ((this.totalTime - this.timeLeft) / this.totalTime) * 100;
            const circumference = 2 * Math.PI * 120; // radius = 120
            const strokeDashoffset = circumference - (progress / 100) * circumference;
            
            // Create progress circle if it doesn't exist
            let svg = this.progressCircle.querySelector('svg');
            if (!svg) {
                svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', '250');
                svg.setAttribute('height', '250');
                svg.setAttribute('viewBox', '0 0 250 250');
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', '125');
                circle.setAttribute('cy', '125');
                circle.setAttribute('r', '120');
                circle.setAttribute('fill', 'none');
                circle.setAttribute('stroke', 'rgba(255, 255, 255, 0.1)');
                circle.setAttribute('stroke-width', '8');
                
                const progressCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                progressCircle.setAttribute('cx', '125');
                progressCircle.setAttribute('cy', '125');
                progressCircle.setAttribute('r', '120');
                progressCircle.setAttribute('fill', 'none');
                progressCircle.setAttribute('stroke', this.isBreak ? '#10B981' : '#3B82F6');
                progressCircle.setAttribute('stroke-width', '8');
                progressCircle.setAttribute('stroke-linecap', 'round');
                progressCircle.setAttribute('stroke-dasharray', circumference);
                progressCircle.setAttribute('stroke-dashoffset', strokeDashoffset);
                progressCircle.setAttribute('transform', 'rotate(-90 125 125)');
                progressCircle.style.transition = 'stroke-dashoffset 1s ease';
                
                svg.appendChild(circle);
                svg.appendChild(progressCircle);
                this.progressCircle.insertBefore(svg, this.timerDisplay);
            } else {
                const progressCircle = svg.children[1];
                progressCircle.setAttribute('stroke-dashoffset', strokeDashoffset);
                progressCircle.setAttribute('stroke', this.isBreak ? '#10B981' : '#3B82F6');
            }
        }
        
        getTaskTitle() {
            const selectedOption = this.taskSelector.options[this.taskSelector.selectedIndex];
            return selectedOption ? selectedOption.textContent : '';
        }
        
        updateTaskStatus(taskId, completed) {
            // Make AJAX request to update task status
            fetch('/tasks/update-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify({
                    task_id: taskId,
                    completed: completed
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Task status updated successfully');
                }
            })
            .catch(error => {
                console.error('Error updating task status:', error);
            });
        }
        
        showNotification(title, body) {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification(title, { body, icon: '/static/favicon.ico' });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification(title, { body, icon: '/static/favicon.ico' });
                        }
                    });
                }
            }
        }
        
        saveStats() {
            localStorage.setItem('focus_sessions', this.sessionsCompleted.toString());
            localStorage.setItem('total_focus_time', this.totalFocusTime.toString());
        }
        
        loadStats() {
            this.sessionsCompleted = parseInt(localStorage.getItem('focus_sessions') || '0');
            this.totalFocusTime = parseInt(localStorage.getItem('total_focus_time') || '0');
            this.updateStatsDisplay();
        }
        
        updateStatsDisplay() {
            this.sessionsCount.textContent = this.sessionsCompleted;
            const hours = Math.floor(this.totalFocusTime / 3600);
            const minutes = Math.floor((this.totalFocusTime % 3600) / 60);
            this.totalTimeElement.textContent = `${hours}h ${minutes}m`;
        }
    }
    
    // Global timer functions for backward compatibility
    let timer;
    
    function toggleTimer() {
        timer.toggleTimer();
    }
    
    function resetTimer() {
        timer.resetTimer();
    }
    
    // Initialize timer when page loads
    document.addEventListener('DOMContentLoaded', function() {
        timer = new EnhancedTimer();
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Enhanced task interaction
        initializeTaskInteraction();
    });
    
    function initializeTaskInteraction() {
        // Make entire task item clickable to toggle checkbox
        const taskItems = document.querySelectorAll('.task-item');
        
        taskItems.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            const content = item.querySelector('.task-content');
            
            if (checkbox) {
                // Click anywhere on task item to toggle checkbox
                item.addEventListener('click', function(e) {
                    // Don't trigger if clicking directly on checkbox
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                        updateTaskCompletion(checkbox);
                    }
                });
                
                // Handle checkbox change
                checkbox.addEventListener('change', function() {
                    updateTaskCompletion(this);
                });
                
                // Initialize visual state
                updateTaskVisualState(item, checkbox.checked);
            }
        });
    }
    
    function updateTaskCompletion(checkbox) {
        const taskItem = checkbox.closest('.task-item');
        const isCompleted = checkbox.checked;
        
        // Update visual state
        updateTaskVisualState(taskItem, isCompleted);
        
        // Send AJAX request to update task status
        const taskId = checkbox.dataset.taskId;
        if (taskId) {
            fetch(`/tasks/${taskId}/toggle/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    completed: isCompleted
                })
            }).catch(error => {
                console.error('Error updating task:', error);
                // Revert checkbox state on error
                checkbox.checked = !isCompleted;
                updateTaskVisualState(taskItem, !isCompleted);
            });
        }
    }
    
    function updateTaskVisualState(taskItem, isCompleted) {
        if (isCompleted) {
            taskItem.classList.add('completed');
        } else {
            taskItem.classList.remove('completed');
        }
    }
</script>
{% endblock %}
