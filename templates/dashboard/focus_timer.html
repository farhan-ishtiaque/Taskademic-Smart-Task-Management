{% extends 'base.html' %}
{% load static %}

{% block title %}Focus Timer - Taskademic{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    .focus-timer-content {
        font-family: 'Inter', sans-serif;
    }
    
    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }
    
    .card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .task-category {
        margin-bottom: 2rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    /* Modern Confirmation Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        max-width: 480px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        transform: scale(0.9) translateY(20px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-overlay.show .modal-content {
        transform: scale(1) translateY(0);
    }
    
    .modal-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .modal-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 1rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .modal-icon.complete {
        background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
    }
    
    .modal-icon.incomplete {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    }
    
    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    
    .modal-message {
        font-size: 1rem;
        color: #6b7280;
        line-height: 1.6;
        margin-bottom: 0.5rem;
    }
    
    .modal-task-name {
        font-weight: 600;
        color: #4f46e5;
        background: #f0f0ff;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        word-break: break-word;
    }
    
    .modal-subtitle {
        font-size: 0.875rem;
        color: #9ca3af;
        font-style: italic;
    }
    
    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        justify-content: center;
    }
    
    .modal-btn {
        padding: 0.875rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .modal-btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .modal-btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .modal-btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    
    .modal-btn-secondary {
        background: #f8fafc;
        color: #64748b;
        border: 2px solid #e2e8f0;
    }
    
    .modal-btn-secondary:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        transform: translateY(-1px);
    }
    
    .modal-btn:active {
        transform: translateY(0);
    }
    
    /* Animation for modal appearance */
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    
    .modal-overlay.show .modal-content {
        animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .task-category:hover {
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
    }
    
    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .category-title {
        font-weight: 600;
        color: #374151;
        font-size: 1rem;
    }
    
    .category-count {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .task-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f3f4f6;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .task-item:last-child {
        border-bottom: none;
    }
    
    .task-item:hover {
        background: #f8fafc;
    }
    
    .task-item-inner {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .checkbox-container input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 4px;
        border: 2px solid #667eea;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .checkbox-container input[type="checkbox"]:checked {
        background: #667eea;
        border-color: #667eea;
    }
    
    .checkbox-container input[type="checkbox"]:checked::after {
        content: "‚úì";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
    }
    
    .task-content {
        flex: 1;
        min-width: 0;
    }
    
    .task-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
        line-height: 1.3;
    }
    
    .task-description {
        color: #6b7280;
        font-size: 0.75rem;
        line-height: 1.4;
    }
    
    .task-item.completed .task-title {
        text-decoration: line-through;
        color: #9ca3af;
    }
    
    .task-item.completed .task-description {
        color: #d1d5db;
    }
    
    .empty-state {
        padding: 2rem;
        text-align: center;
        color: #9ca3af;
        font-style: italic;
    }
    
    /* Category-specific colors */
    .big-things {
        border-color: #fca5a5;
    }
    .big-things .category-header {
        background: #fef2f2;
    }
    .big-things .category-count {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .medium-things {
        border-color: #fcd34d;
    }
    .medium-things .category-header {
        background: #fffbeb;
    }
    .medium-things .category-count {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .small-things {
        border-color: #86efac;
    }
    .small-things .category-header {
        background: #f0fdf4;
    }
    .small-things .category-count {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }
    
    /* Timer Section */
    .timer-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .timer-setup {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }
    
    .timer-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        color: white;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .timer-clock {
        font-size: 3rem;
        font-weight: 700;
        color: white;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .timer-label {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
        margin-bottom: 2rem;
        font-weight: 500;
    }
    
    .progress-ring {
        width: 150px;
        height: 150px;
        margin: 0 auto 1.5rem;
        position: relative;
    }
    
    .progress-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: rgba(255, 255, 255, 0.1);
    }
    
    .timer-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1.5rem;
    }
    
    .control-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }
    
    .control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
    }
    
    .control-btn.primary {
        background: rgba(255, 255, 255, 0.9);
        color: #667eea;
        border-color: rgba(255, 255, 255, 0.9);
    }
    
    .control-btn.primary:hover {
        background: white;
        color: #4f46e5;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        display: block;
        color: #374151;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        color: #1f2937;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Custom timer input styling */
    input[type="number"].form-select {
        -moz-appearance: textfield;
    }
    
    input[type="number"].form-select::-webkit-outer-spin-button,
    input[type="number"].form-select::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    #custom-timer-settings {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        border: 1px solid #e5e7eb;
    }
    
    #custom-timer-settings .form-group:last-child {
        margin-bottom: 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .stat-box {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .stat-label {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.75rem;
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
        
        .timer-clock {
            font-size: 2.5rem;
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 focus-timer-content">
    <!-- Main content -->
    <div class="px-4 py-6 sm:px-0">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">üéØ Focus Timer</h1>
            <p class="mt-2 text-gray-600">Boost your productivity with focused work sessions</p>
            
            <!-- Context Info Banner -->
            {% if source %}
                <div class="mt-4 p-3 rounded-lg border-l-4 {% if source == 'custom' %}border-blue-500 bg-blue-50{% elif source == 'ai' %}border-green-500 bg-green-50{% else %}border-gray-500 bg-gray-50{% endif %}">
                    <div class="flex items-center">
                        <div class="ml-3">
                            <p class="text-sm {% if source == 'custom' %}text-blue-800{% elif source == 'ai' %}text-green-800{% else %}text-gray-800{% endif %}">
                                {% if source == 'custom' %}
                                    üìÖ <strong>Custom Schedule</strong>
                                {% elif source == 'ai' %}
                                    ü§ñ <strong>AI Generated Schedule</strong>
                                {% elif source == 'direct' %}
                                    üìã <strong>All Tasks</strong>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Content -->
        <main>
            <div class="max-w-7xl mx-auto">
                <div class="content-grid">
        <!-- Tasks Section -->
        <div class="tasks-section">
            <div class="card">
                <h2 class="section-title">
                    <i class="fas fa-tasks"></i>
                    Today's Tasks
                </h2>
                
                <!-- All Tasks -->
                <div class="task-category all-tasks">
                    <div class="category-header">

                        <div class="category-title">
                            {% if has_schedule %}
                                {% if source == 'custom' %}
                                    üìÖ Custom Schedule
                                {% elif source == 'ai' %}
                                    ü§ñ AI Generated Schedule
                                {% else %}
                                    üìÖ Today's Schedule
                                {% endif %}
                            {% elif source == 'direct' %}
                                üìã All Tasks
                            {% else %}
                                üìã All Tasks
                            {% endif %}
                        </div>
                        <div class="category-count">
                            {% if has_schedule %}
                                {{ scheduled_tasks|length }}
                            {% else %}
                                {% with total_tasks=must_do_tasks|length|add:should_do_tasks|length|add:could_do_tasks|length %}
                                    {{ total_tasks }}
                                {% endwith %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="task-list">
                        {% if has_schedule %}
                            <!-- Show Scheduled Tasks with Time Slots -->
                            {% for scheduled_task in scheduled_tasks %}
                                {% if scheduled_task.task %}
                                    <div class="task-item {% if scheduled_task.task.status == 'completed' or scheduled_task.is_completed %}completed{% endif %}" data-task-id="{{ scheduled_task.task.id }}">
                                        <div class="task-item-inner">
                                            <div class="checkbox-container">
                                                <input type="checkbox" 
                                                       id="task-{{ scheduled_task.task.id }}" 
                                                       {% if scheduled_task.task.status == 'completed' or scheduled_task.is_completed %}checked{% endif %}
                                                       onchange="updateTaskStatus({{ scheduled_task.task.id }}, this.checked)">
                                            </div>
                                            <div class="task-content">
                                                <div class="task-title">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span>
                                                            {{ scheduled_task.task.title }}
                                                        </span>
                                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                            {% if scheduled_task.task.moscow_category == 'must' %}
                                                                <span class="badge bg-danger" style="font-size: 0.7rem;">MUST</span>
                                                            {% elif scheduled_task.task.moscow_category == 'should' %}
                                                                <span class="badge bg-warning" style="font-size: 0.7rem;">SHOULD</span>
                                                            {% elif scheduled_task.task.moscow_category == 'could' %}
                                                                <span class="badge bg-info" style="font-size: 0.7rem;">COULD</span>
                                                            {% elif scheduled_task.task.moscow_category == 'wont' %}
                                                                <span class="badge bg-secondary" style="font-size: 0.7rem;">WON'T</span>
                                                            {% endif %}
                                                            <span class="badge bg-primary" style="font-size: 0.7rem;">
                                                                {{ scheduled_task.start_time|time:"H:i" }} - {{ scheduled_task.end_time|time:"H:i" }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="task-description">
                                                    <div>{{ scheduled_task.task.description|truncatewords:15 }}</div>
                                                    <div style="margin-top: 0.25rem; color: #6b7280; font-size: 0.7rem;">
                                                        {% if scheduled_task.schedule_type == 'custom' %}
                                                            <!-- Custom Schedule: Simple format -->
                                                            ‚è±Ô∏è {{ scheduled_task.task.title }}
                                                            {% if scheduled_task.task.due_date %}
                                                                ‚Ä¢ Due: {{ scheduled_task.task.due_date|date:"M d" }}
                                                            {% endif %}
                                                        {% else %}
                                                            <!-- AI Schedule: Detailed format -->
                                                            üçÖ {{ scheduled_task.pomodoro_sessions }} session{% if scheduled_task.pomodoro_sessions != 1 %}s{% endif %}, 
                                                            {{ scheduled_task.break_minutes }}min breaks ‚Ä¢ 
                                                            {{ scheduled_task.estimated_duration_minutes }}min total
                                                            {% if scheduled_task.task.due_date %}
                                                                ‚Ä¢ Due: {{ scheduled_task.task.due_date|date:"M d" }}
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                            
                            {% if not scheduled_tasks %}
                                <div class="empty-state">
                                    <div style="margin-bottom: 1rem;">üìÖ No schedule for today</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        <a href="{% url 'dashboard:daily_schedule_home' %}" style="color: #3b82f6; text-decoration: none;">
                                            Generate an AI schedule
                                        </a> or 
                                        <a href="{% url 'dashboard:daily_schedule_home' %}" style="color: #3b82f6; text-decoration: none;">
                                            create a custom schedule
                                        </a> to see your planned tasks here.
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            <!-- Show Regular Tasks by Priority (Fallback) -->
                            <!-- Show Regular Tasks by Priority (Fallback) -->
                            <!-- Must Do Tasks (High Priority) -->
                            {% for task in must_do_tasks %}
                                <div class="task-item {% if task.status == 'completed' %}completed{% endif %}" data-task-id="{{ task.id }}">
                                    <div class="task-item-inner">
                                        <div class="checkbox-container">
                                            <input type="checkbox" 
                                                   id="task-{{ task.id }}" 
                                                   {% if task.status == 'completed' %}checked{% endif %}
                                                   onchange="updateTaskStatus({{ task.id }}, this.checked)">
                                        </div>
                                        <div class="task-content">
                                            <div class="task-title">
                                                {{ task.title }}
                                            </div>
                                            <div class="task-description">{{ task.description|truncatewords:20 }}</div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            <!-- Should Do Tasks (Medium Priority) -->
                            {% for task in should_do_tasks %}
                                <div class="task-item {% if task.status == 'completed' %}completed{% endif %}" data-task-id="{{ task.id }}">
                                    <div class="task-item-inner">
                                        <div class="checkbox-container">
                                            <input type="checkbox" 
                                                   id="task-{{ task.id }}" 
                                                   {% if task.status == 'completed' %}checked{% endif %}
                                                   onchange="updateTaskStatus({{ task.id }}, this.checked)">
                                        </div>
                                        <div class="task-content">
                                            <div class="task-title">
                                                {{ task.title }}
                                            </div>
                                            <div class="task-description">{{ task.description|truncatewords:15 }}</div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            <!-- Could Do Tasks (Low Priority) -->
                            {% for task in could_do_tasks %}
                                <div class="task-item {% if task.status == 'completed' %}completed{% endif %}" data-task-id="{{ task.id }}">
                                    <div class="task-item-inner">
                                        <div class="checkbox-container">
                                            <input type="checkbox" 
                                                   id="task-{{ task.id }}" 
                                                   {% if task.status == 'completed' %}checked{% endif %}
                                                   onchange="updateTaskStatus({{ task.id }}, this.checked)">
                                        </div>
                                        <div class="task-content">
                                            <div class="task-title">
                                                {{ task.title }}
                                            </div>
                                            <div class="task-description">{{ task.description|truncatewords:10 }}</div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            {% if not must_do_tasks and not should_do_tasks and not could_do_tasks %}
                                <div class="empty-state">No tasks available. Add some tasks to start focusing!</div>
                            {% endif %}

                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Timer Section -->
        <div class="timer-section">
            <!-- Timer Setup -->
            <div class="timer-setup">
                <h3 class="section-title" style="font-size: 1.2rem; margin-bottom: 1.5rem;">‚è∞ Timer Setup</h3>
                
                <div class="form-group">

                    <label class="form-label">Technique</label>
                    <select class="form-select" id="technique-selector">
                        <option value="pomodoro">üçÖ Pomodoro (25min/5min)</option>
                        <option value="52-17">‚è∞ 52/17 (52min/17min)</option>
                        <option value="custom">‚öôÔ∏è Custom Timer</option>
                    </select>
                </div>
                
                <!-- Custom Timer Settings (hidden by default) -->
                <div id="custom-timer-settings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Focus Time (minutes)</label>
                        <input type="number" 
                               class="form-select" 
                               id="custom-focus-time" 
                               value="25" 
                               min="1" 
                               max="120" 
                               placeholder="Enter focus time">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Break Time (minutes)</label>
                        <input type="number" 
                               class="form-select" 
                               id="custom-break-time" 
                               value="5" 
                               min="1" 
                               max="60" 
                               placeholder="Enter break time">
                    </div>
                </div>
            </div>
            
            <!-- Timer Display -->
            <div class="timer-display">
                <div class="progress-ring">
                    <div class="progress-circle" id="progress-circle">
                        <div class="timer-clock" id="timer-display">25:00</div>
                    </div>
                </div>
                
                <div class="timer-label" id="timer-phase">Ready to focus</div>
                
                <div class="timer-controls">
                    <button class="control-btn primary" id="start-btn" onclick="toggleTimer()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h10a2 2 0 012 2v8a2 2 0 01-2-2v-8a2 2 0 012-2z"/>
                        </svg>
                        Start Focus
                    </button>
                    <button class="control-btn" id="reset-btn" onclick="resetTimer()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Reset
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number" id="sessions-count">0</div>
                        <div class="stat-label">Sessions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="total-time">0h</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </main>
    </div>
</div>

<script>
    // Enhanced Focus Timer
    class FocusTimer {
        constructor() {
            this.timeLeft = 25 * 60; // 25 minutes in seconds
            this.totalTime = 25 * 60;
            this.isRunning = false;
            this.isBreak = false;
            this.interval = null;
            this.currentTask = null;
            this.sessionsCompleted = parseInt(localStorage.getItem('focus_sessions') || '0');
            this.totalFocusTime = parseInt(localStorage.getItem('total_focus_time') || '0');
            
            this.techniques = {
                pomodoro: { work: 25, break: 5 },
                '52-17': { work: 52, break: 17 },
                custom: { work: 25, break: 5 }
            };
            
            this.initializeElements();
            this.bindEvents();
            this.toggleCustomSettings(); // Initialize custom settings visibility
            this.updateStatsDisplay();
            this.updateDisplay();
            this.updateProgress();
        }
        
        initializeElements() {
            this.timerDisplay = document.getElementById('timer-display');
            this.progressCircle = document.getElementById('progress-circle');
            this.timerPhase = document.getElementById('timer-phase');
            this.startBtn = document.getElementById('start-btn');
            this.resetBtn = document.getElementById('reset-btn');
            this.techniqueSelector = document.getElementById('technique-selector');
            this.sessionsCount = document.getElementById('sessions-count');
            this.totalTimeElement = document.getElementById('total-time');
            this.customTimerSettings = document.getElementById('custom-timer-settings');
            this.customFocusTime = document.getElementById('custom-focus-time');
            this.customBreakTime = document.getElementById('custom-break-time');
        }
        
        bindEvents() {
            this.techniqueSelector.addEventListener('change', () => {
                this.updateTechnique();
                this.toggleCustomSettings();
            });
            
            // Listen for custom time changes
            this.customFocusTime.addEventListener('change', () => {
                if (this.techniqueSelector.value === 'custom') {
                    this.updateCustomTechnique();
                }
            });
            
            this.customBreakTime.addEventListener('change', () => {
                if (this.techniqueSelector.value === 'custom') {
                    this.updateCustomTechnique();
                }
            });
        }
        
        toggleCustomSettings() {
            if (this.techniqueSelector.value === 'custom') {
                this.customTimerSettings.style.display = 'block';
            } else {
                this.customTimerSettings.style.display = 'none';
            }
        }
        
        updateCustomTechnique() {
            const focusTime = parseInt(this.customFocusTime.value) || 25;
            const breakTime = parseInt(this.customBreakTime.value) || 5;
            
            // Update the custom technique settings
            this.techniques.custom = { work: focusTime, break: breakTime };
            
            // Update current timer if not running and not in break
            if (!this.isRunning && !this.isBreak) {
                this.timeLeft = focusTime * 60;
                this.totalTime = focusTime * 60;
                this.updateDisplay();
                this.updateProgress();
            }
        }
        
        updateTechnique() {
            const technique = this.techniqueSelector.value;
            
            if (technique === 'custom') {
                this.updateCustomTechnique();
            } else {
                const settings = this.techniques[technique];
                this.timeLeft = settings.work * 60;
                this.totalTime = settings.work * 60;
            }
            
            this.isBreak = false;
            this.updateDisplay();
            this.updateProgress();
        }
        
        toggleTimer() {
            if (this.isRunning) {
                this.pauseTimer();
            } else {
                this.startTimer();
            }
        }
        
        startTimer() {
            this.isRunning = true;
            this.startBtn.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6l4-2z"/>
                </svg>
                Pause
            `;
            
            this.interval = setInterval(() => {
                this.timeLeft--;
                this.updateDisplay();
                this.updateProgress();
                
                if (this.timeLeft <= 0) {
                    this.completeSession();
                }
            }, 1000);
            
            // Update timer phase
            if (this.isBreak) {
                this.timerPhase.textContent = 'Break Time üßò‚Äç‚ôÄÔ∏è';
            } else {
                this.timerPhase.textContent = this.currentTask ? 
                    `Focusing on selected task` : 'Focus Session üéØ';
            }
        }
        
        pauseTimer() {
            this.isRunning = false;
            clearInterval(this.interval);
            this.startBtn.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h10a2 2 0 012 2v8a2 2 0 01-2-2v-8a2 2 0 012-2z"/>
                </svg>
                Resume
            `;
            this.timerPhase.textContent = 'Paused ‚è∏Ô∏è';
        }
        
        resetTimer() {
            this.isRunning = false;
            clearInterval(this.interval);
            
            const technique = this.techniqueSelector.value;
            
            if (this.isBreak) {
                let breakTime;
                if (technique === 'custom') {
                    breakTime = parseInt(this.customBreakTime.value) || 5;
                } else {
                    const settings = this.techniques[technique];
                    breakTime = settings.break || 5;
                }
                this.timeLeft = breakTime * 60;
                this.totalTime = breakTime * 60;
            } else {
                let workTime;
                if (technique === 'custom') {
                    workTime = parseInt(this.customFocusTime.value) || 25;
                } else {
                    const settings = this.techniques[technique];
                    workTime = settings.work || 25;
                }
                this.timeLeft = workTime * 60;
                this.totalTime = workTime * 60;
            }
            
            this.updateDisplay();
            this.updateProgress();
            
            this.startBtn.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h10a2 2 0 012 2v8a2 2 0 01-2-2v-8a2 2 0 012-2z"/>
                </svg>
                Start Focus
            `;
            this.timerPhase.textContent = 'Ready to focus';
        }
        
        completeSession() {
            this.isRunning = false;
            clearInterval(this.interval);
            
            if (!this.isBreak) {
                // Focus session completed
                this.sessionsCompleted++;
                this.totalFocusTime += this.totalTime;
                this.saveStats();
                this.updateStatsDisplay();
                
                // Show notification
                this.showNotification('üéâ Focus session completed!', 'Time for a break');
                
                // Switch to break
                this.switchToBreak();
            } else {
                // Break completed
                this.showNotification('Break over!', 'Ready for another focus session?');
                this.switchToFocus();
            }
        }
        
        switchToBreak() {
            this.isBreak = true;
            const technique = this.techniqueSelector.value;
            
            let breakTime;
            if (technique === 'custom') {
                breakTime = parseInt(this.customBreakTime.value) || 5;
            } else {
                const settings = this.techniques[technique];
                breakTime = settings.break || 5;
            }
            
            this.timeLeft = breakTime * 60;
            this.totalTime = breakTime * 60;
            this.timerPhase.textContent = 'Break Time üßò‚Äç‚ôÄÔ∏è';
            
            this.updateDisplay();
            this.updateProgress();
            
            // Auto-start break timer
            this.startTimer();
        }
        
        switchToFocus() {
            this.isBreak = false;
            const technique = this.techniqueSelector.value;
            
            let workTime;
            if (technique === 'custom') {
                workTime = parseInt(this.customFocusTime.value) || 25;
            } else {
                const settings = this.techniques[technique];
                workTime = settings.work || 25;
            }
            
            this.timeLeft = workTime * 60;
            this.totalTime = workTime * 60;
            this.timerPhase.textContent = 'Ready to focus';
            
            this.updateDisplay();
            this.updateProgress();
            
            this.startBtn.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h10a2 2 0 012 2v8a2 2 0 01-2-2v-8a2 2 0 012-2z"/>
                </svg>
                Start Focus
            `;
        }
        
        updateDisplay() {
            const minutes = Math.floor(this.timeLeft / 60);
            const seconds = this.timeLeft % 60;
            this.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        updateProgress() {
            const progress = ((this.totalTime - this.timeLeft) / this.totalTime) * 100;
            
            // Create or update progress SVG
            let svg = this.progressCircle.querySelector('svg');
            if (!svg) {
                svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', '150');
                svg.setAttribute('height', '150');
                svg.setAttribute('viewBox', '0 0 150 150');
                svg.style.position = 'absolute';
                svg.style.top = '0';
                svg.style.left = '0';
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', '75');
                circle.setAttribute('cy', '75');
                circle.setAttribute('r', '70');
                circle.setAttribute('fill', 'none');
                circle.setAttribute('stroke', 'rgba(255, 255, 255, 0.2)');
                circle.setAttribute('stroke-width', '4');
                
                const progressCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                progressCircle.setAttribute('cx', '75');
                progressCircle.setAttribute('cy', '75');
                progressCircle.setAttribute('r', '70');
                progressCircle.setAttribute('fill', 'none');
                progressCircle.setAttribute('stroke', this.isBreak ? '#10B981' : '#ffffff');
                progressCircle.setAttribute('stroke-width', '4');
                progressCircle.setAttribute('stroke-linecap', 'round');
                progressCircle.setAttribute('stroke-dasharray', '439.82');
                progressCircle.setAttribute('stroke-dashoffset', '439.82');
                progressCircle.setAttribute('transform', 'rotate(-90 75 75)');
                progressCircle.style.transition = 'stroke-dashoffset 1s ease';
                progressCircle.id = 'progress-path';
                
                svg.appendChild(circle);
                svg.appendChild(progressCircle);
                this.progressCircle.appendChild(svg);
            }
            
            const progressPath = document.getElementById('progress-path');
            if (progressPath) {
                const offset = 439.82 - (progress / 100) * 439.82;
                progressPath.setAttribute('stroke-dashoffset', offset);
                progressPath.setAttribute('stroke', this.isBreak ? '#10B981' : '#ffffff');
            }
        }
        
        showNotification(title, body) {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification(title, { body, icon: '/static/favicon.ico' });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification(title, { body, icon: '/static/favicon.ico' });
                        }
                    });
                }
            }
        }
        
        saveStats() {
            localStorage.setItem('focus_sessions', this.sessionsCompleted.toString());
            localStorage.setItem('total_focus_time', this.totalFocusTime.toString());
        }
        
        updateStatsDisplay() {
            this.sessionsCount.textContent = this.sessionsCompleted;
            const hours = Math.floor(this.totalFocusTime / 3600);
            const minutes = Math.floor((this.totalFocusTime % 3600) / 60);
            this.totalTimeElement.textContent = `${hours}h ${minutes}m`;
        }
    }
    
    // Global timer instance
    let timer;
    
    function toggleTimer() {
        timer.toggleTimer();
    }
    
    function resetTimer() {
        timer.resetTimer();
    }
    
    async function updateTaskStatus(taskId, completed) {
        const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
        const checkbox = taskElement?.querySelector('input[type="checkbox"]');
        const taskTitle = taskElement?.querySelector('.task-title')?.textContent?.trim() || 'this task';
        
        let confirmResult = false;
        
        // If trying to complete a task, show confirmation
        if (completed) {
            confirmResult = await showConfirmModal({
                type: 'complete',
                icon: '‚úì',
                title: 'Mark Task as Complete?',
                message: 'You\'re about to mark this task as completed:',
                taskName: taskTitle,
                subtitle: 'Completed tasks will be removed from your focus list.',
                confirmText: 'Mark Complete'
            });
            
            if (!confirmResult) {
                // User cancelled, revert checkbox
                if (checkbox) checkbox.checked = false;
                return;
            }
        }
        
        // If unchecking a completed task, show confirmation
        if (!completed && taskElement?.classList.contains('completed')) {
            confirmResult = await showConfirmModal({
                type: 'incomplete',
                icon: '‚Ü∫',
                title: 'Mark Task as Incomplete?',
                message: 'You\'re about to mark this task as incomplete:',
                taskName: taskTitle,
                subtitle: 'This will move it back to your active task list.',
                confirmText: 'Mark Incomplete'
            });
            
            if (!confirmResult) {
                // User cancelled, revert checkbox
                if (checkbox) checkbox.checked = true;
                return;
            }
        }
        
        // Update task status via AJAX
        fetch(`/tasks/${taskId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                completed: completed
            })
        }).then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        }).then(data => {
              if (data.success) {
                  if (data.remove_task && completed) {
                      // Remove task from UI with animation
                      if (taskElement) {
                          taskElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                          taskElement.style.opacity = '0';
                          taskElement.style.transform = 'translateX(100%)';
                          setTimeout(() => {
                              taskElement.remove();
                              // Update task counts
                              updateTaskCounts();
                          }, 300);
                      }
                      
                      // Show success message
                      if (data.message) {
                          showNotification(data.message, 'success');
                      }
                  } else if (!completed) {
                      // Task marked as incomplete, update UI
                      if (taskElement) {
                          taskElement.classList.remove('completed');
                          const title = taskElement.querySelector('.task-title');
                          if (title) {
                              title.style.textDecoration = 'none';
                              title.style.color = '#1f2937';
                          }
                      }
                      if (data.message) {
                          showNotification(data.message, 'info');
                      }
                  }
              } else {
                  console.error('Error updating task:', data.error);
                  showNotification(data.error || 'Failed to update task', 'error');
                  
                  // Revert checkbox state on error
                  if (checkbox) checkbox.checked = !completed;
              }
          })
          .catch(error => {
              console.error('Error:', error);
              showNotification('Network error: Failed to update task', 'error');
              
              // Revert checkbox state on error
              if (checkbox) checkbox.checked = !completed;
          });
    }
    
    function updateTaskCounts() {
        // Count remaining tasks in each category
        const mustDoCount = document.querySelectorAll('.task-category[data-category="must"] .task-item').length;
        const shouldDoCount = document.querySelectorAll('.task-category[data-category="should"] .task-item').length;
        const couldDoCount = document.querySelectorAll('.task-category[data-category="could"] .task-item').length;
        
        // Update count displays if they exist
        const mustCountElement = document.querySelector('.must-count');
        const shouldCountElement = document.querySelector('.should-count');
        const couldCountElement = document.querySelector('.could-count');
        
        if (mustCountElement) mustCountElement.textContent = mustDoCount;
        if (shouldCountElement) shouldCountElement.textContent = shouldDoCount;
        if (couldCountElement) couldCountElement.textContent = couldDoCount;
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 
            type === 'error' ? 'bg-red-500 text-white' : 
            'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.transition = 'opacity 0.3s ease';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // Initialize timer when page loads
    document.addEventListener('DOMContentLoaded', function() {
        timer = new FocusTimer();
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Make task items clickable
        document.querySelectorAll('.task-item').forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) {
                item.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                        const event = new Event('change');
                        checkbox.dispatchEvent(event);
                    }
                });
                
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        item.classList.add('completed');
                    } else {
                        item.classList.remove('completed');
                    }
                });
            }
        });
    });
    
    // Custom Modal Functions
    function showConfirmModal(options) {
        return new Promise((resolve) => {
            const modalOverlay = document.getElementById('confirmModal');
            const modalIcon = modalOverlay.querySelector('.modal-icon');
            const modalTitle = modalOverlay.querySelector('.modal-title');
            const modalMessage = modalOverlay.querySelector('.modal-message');
            const modalTaskName = modalOverlay.querySelector('.modal-task-name');
            const modalSubtitle = modalOverlay.querySelector('.modal-subtitle');
            const confirmBtn = modalOverlay.querySelector('.modal-btn-primary');
            const cancelBtn = modalOverlay.querySelector('.modal-btn-secondary');
            
            // Set modal content
            modalIcon.innerHTML = options.icon;
            modalIcon.className = `modal-icon ${options.type}`;
            modalTitle.textContent = options.title;
            modalMessage.textContent = options.message;
            modalTaskName.textContent = options.taskName;
            modalSubtitle.textContent = options.subtitle;
            confirmBtn.textContent = options.confirmText;
            
            // Show modal
            modalOverlay.classList.add('show');
            
            // Handle button clicks
            const handleConfirm = () => {
                modalOverlay.classList.remove('show');
                cleanup();
                resolve(true);
            };
            
            const handleCancel = () => {
                modalOverlay.classList.remove('show');
                cleanup();
                resolve(false);
            };
            
            const handleClickOutside = (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.remove('show');
                    cleanup();
                    resolve(false);
                }
            };
            
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    modalOverlay.classList.remove('show');
                    cleanup();
                    resolve(false);
                }
            };
            
            const cleanup = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
                modalOverlay.removeEventListener('click', handleClickOutside);
                document.removeEventListener('keydown', handleEscape);
            };
            
            // Add event listeners
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            modalOverlay.addEventListener('click', handleClickOutside);
            document.addEventListener('keydown', handleEscape);
            
            // Focus the confirm button for accessibility
            setTimeout(() => confirmBtn.focus(), 100);
        });
    }
</script>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-icon">
                ‚úì
            </div>
            <h3 class="modal-title">Confirm Action</h3>
            <p class="modal-message">Are you sure you want to continue?</p>
            <div class="modal-task-name">Task Name</div>
            <p class="modal-subtitle">Additional information</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="modal-btn modal-btn-secondary">Cancel</button>
            <button type="button" class="modal-btn modal-btn-primary">Confirm</button>
        </div>
    </div>
</div>

{% endblock %}
