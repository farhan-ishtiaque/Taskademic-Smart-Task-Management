{% extends 'base.html' %}

{% block title %}Settings - Taskademic{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Settings</h1>
        <p class="mt-2 text-gray-600">Manage your account and application preferences</p>
    </div>

    <!-- Messages -->
    {% if messages %}
        <div class="space-y-3">
            {% for message in messages %}
                <div class="rounded-md p-4 {% if message.tags == 'success' %}bg-green-50 border border-green-200{% elif message.tags == 'error' %}bg-red-50 border border-red-200{% else %}bg-blue-50 border border-blue-200{% endif %}">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            {% if message.tags == 'success' %}
                                <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                            {% elif message.tags == 'error' %}
                                <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            {% endif %}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium {% if message.tags == 'success' %}text-green-800{% elif message.tags == 'error' %}text-red-800{% else %}text-blue-800{% endif %}">
                                {{ message }}
                            </p>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Settings Sections -->
    <div class="space-y-6">
        <!-- Profile Settings -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Profile Information</h3>
            </div>
            <div class="p-6">
                <form method="post" class="space-y-4">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">First Name</label>
                            <input type="text" name="first_name" value="{{ user.first_name }}"
                                   class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Last Name</label>
                            <input type="text" name="last_name" value="{{ user.last_name }}"
                                   class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" name="email" value="{{ user.email }}"
                               class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Timezone</label>
                        <select name="timezone" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="UTC" {% if user.userprofile.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                            <option value="America/New_York" {% if user.userprofile.timezone == 'America/New_York' %}selected{% endif %}>Eastern Time (EST/EDT)</option>
                            <option value="America/Chicago" {% if user.userprofile.timezone == 'America/Chicago' %}selected{% endif %}>Central Time (CST/CDT)</option>
                            <option value="America/Denver" {% if user.userprofile.timezone == 'America/Denver' %}selected{% endif %}>Mountain Time (MST/MDT)</option>
                            <option value="America/Los_Angeles" {% if user.userprofile.timezone == 'America/Los_Angeles' %}selected{% endif %}>Pacific Time (PST/PDT)</option>
                            <option value="Europe/London" {% if user.userprofile.timezone == 'Europe/London' %}selected{% endif %}>London (GMT/BST)</option>
                            <option value="Europe/Paris" {% if user.userprofile.timezone == 'Europe/Paris' %}selected{% endif %}>Paris (CET/CEST)</option>
                            <option value="Asia/Tokyo" {% if user.userprofile.timezone == 'Asia/Tokyo' %}selected{% endif %}>Tokyo (JST)</option>
                            <option value="Asia/Dhaka" {% if user.userprofile.timezone == 'Asia/Dhaka' %}selected{% endif %}>Dhaka (BST)</option>
                        </select>
                        <p class="mt-1 text-sm text-gray-500">Server timezone (Asia/Dhaka) is used for Google Calendar sync</p>
                    </div>
                    <div>
                        <button type="submit" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                            Update Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Notification Preferences -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Notification Preferences</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-sm font-medium text-gray-900">Task Due Date Reminders</label>
                            <p class="text-sm text-gray-500">Get notified when tasks are due soon</p>
                        </div>
                        <input type="checkbox" id="task_due_reminders"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-sm font-medium text-gray-900">Weekly Summary</label>
                            <p class="text-sm text-gray-500">Receive weekly productivity reports</p>
                        </div>
                        <input type="checkbox" id="weekly_summary"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-sm font-medium text-gray-900">Team Updates</label>
                            <p class="text-sm text-gray-500">Get notified about team task updates</p>
                        </div>
                        <input type="checkbox" id="team_updates"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    </div>
                </div>
                <div class="mt-6">
                    <button type="button" id="save-preferences" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Save Preferences
                    </button>
                    <span id="save-status" class="ml-3 text-sm"></span>
                </div>
            </div>
        </div>

        <!-- App Preferences -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">App Preferences</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Default Task Priority</label>
                        <select class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Default View</label>
                        <select class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="dashboard" selected>Dashboard</option>
                            <option value="kanban">Kanban Board</option>
                            <option value="calendar">Calendar</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-sm font-medium text-gray-900">Auto-save</label>
                            <p class="text-sm text-gray-500">Automatically save changes as you type</p>
                        </div>
                        <input type="checkbox" checked
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    </div>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="bg-white shadow rounded-lg border border-red-200">
            <div class="px-6 py-4 border-b border-red-200 bg-red-50">
                <h3 class="text-lg font-medium text-red-900">Danger Zone</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="border-t pt-4">
                        <h4 class="text-sm font-medium text-red-900">Delete Account</h4>
                        <p class="text-sm text-red-600 mb-3">Permanently delete your account and all associated data</p>
                        <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">
                            Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load current notification preferences
    loadNotificationPreferences();
    
    // Save preferences when button is clicked
    document.getElementById('save-preferences').addEventListener('click', saveNotificationPreferences);
    
    function loadNotificationPreferences() {
        fetch('/notifications/preferences/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('task_due_reminders').checked = data.task_due_reminders;
                document.getElementById('weekly_summary').checked = data.weekly_summary;
                document.getElementById('team_updates').checked = data.team_updates;
            })
            .catch(error => {
                console.error('Error loading preferences:', error);
            });
    }
    
    function saveNotificationPreferences() {
        const saveButton = document.getElementById('save-preferences');
        const saveStatus = document.getElementById('save-status');
        
        // Disable button and show loading
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
        saveStatus.textContent = '';
        
        const preferences = {
            task_due_reminders: document.getElementById('task_due_reminders').checked,
            weekly_summary: document.getElementById('weekly_summary').checked,
            team_updates: document.getElementById('team_updates').checked,
        };
        
        fetch('/notifications/preferences/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(preferences)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                saveStatus.textContent = 'Preferences saved successfully!';
                saveStatus.className = 'ml-3 text-sm text-green-600';
            } else {
                saveStatus.textContent = 'Error saving preferences: ' + data.error;
                saveStatus.className = 'ml-3 text-sm text-red-600';
            }
        })
        .catch(error => {
            console.error('Error saving preferences:', error);
            saveStatus.textContent = 'Error saving preferences';
            saveStatus.className = 'ml-3 text-sm text-red-600';
        })
        .finally(() => {
            // Re-enable button
            saveButton.disabled = false;
            saveButton.textContent = 'Save Preferences';
            
            // Clear status message after 3 seconds
            setTimeout(() => {
                saveStatus.textContent = '';
            }, 3000);
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
