{% extends 'base.html' %}

{% block title %}Analytics - Taskademic{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0" x-data="analyticsBoard()">
    <!-- CSRF Token -->
    {% csrf_token %}
    
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Analytics</h1>
            <p class="mt-2 text-gray-600">Insights into your productivity and task management</p>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Tasks</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="analytics.overview?.total_tasks || {{ total_tasks }}"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Completed</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="analytics.overview?.completed_tasks || {{ completed_tasks }}"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Completion Rate</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="(analytics.overview?.completion_rate || {{ completion_rate }}).toFixed(1) + '%'"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Overdue</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="analytics.overview?.overdue_tasks || {{ overdue_tasks }}"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        
        <!-- Task Completion Trend -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Task Completion Trend</h3>
                <p class="mt-1 text-sm text-gray-500">Daily completed tasks over time</p>
            </div>
            <div class="p-6">
                <canvas id="completionChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Status Distribution -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Task Status Distribution</h3>
                <p class="mt-1 text-sm text-gray-500">Current status breakdown</p>
            </div>
            <div class="p-6">
                <canvas id="statusChart" width="400" height="200"></canvas>
            </div>
        </div>

    </div>

    <!-- Second Row Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Task Priority Distribution -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Priority Distribution</h3>
                <p class="mt-1 text-sm text-gray-500">Tasks by priority level</p>
            </div>
            <div class="p-6">
                <canvas id="priorityChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Category Breakdown -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Category Breakdown</h3>
                <p class="mt-1 text-sm text-gray-500">Tasks by category</p>
            </div>
            <div class="p-6">
                <template x-for="category in analytics.category_distribution" :key="category.category">
                    <div class="flex items-center justify-between py-2">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-3 bg-blue-500"></div>
                            <span class="text-sm font-medium text-gray-900" x-text="category.category || 'Uncategorized'"></span>
                        </div>
                        <span class="text-sm text-gray-500" x-text="category.count + ' tasks'"></span>
                    </div>
                </template>
                <div x-show="!analytics.category_distribution || analytics.category_distribution.length === 0" 
                     class="text-gray-500 text-sm">No category data available</div>
            </div>
        </div>

    </div>

    <!-- Loading State -->
    <div x-show="loading" 
         class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-md">
            <div class="flex items-center space-x-3 mb-4">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span class="text-gray-700">Loading analytics...</span>
            </div>
            
            <!-- Error Message -->
            <div x-show="error" class="bg-red-50 border border-red-200 rounded p-3 mb-3">
                <div class="text-sm text-red-700 font-medium mb-1">Error:</div>
                <div class="text-xs text-red-600" x-text="error"></div>
            </div>
            
            <button @click="loading = false" 
                    class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                Continue Anyway
            </button>
        </div>
    </div>
</div>

<script>
function analyticsBoard() {
    return {
        analytics: {},
        loading: false,
        error: null,
        timeRange: '30',
        completionChart: null,
        statusChart: null,
        priorityChart: null,

        async init() {
            await this.loadAnalytics();
        },

        async loadAnalytics() {
            this.loading = true;
            this.error = null;
            console.log('ðŸ” Loading analytics...');
            
            const loadingTimeout = setTimeout(() => {
                if (this.loading) {
                    console.warn('âš ï¸ Analytics loading timeout');
                    this.loading = false;
                }
            }, 10000);
            
            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                const response = await fetch(`/analytics/api/?range=${this.timeRange}`, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken || ''
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('âœ… Analytics data loaded:', data);
                this.analytics = data;
                
                clearTimeout(loadingTimeout);
                
                await this.$nextTick();
                this.renderCharts();
                
            } catch (error) {
                console.error('âŒ Error loading analytics:', error);
                this.error = `Failed to load analytics: ${error.message}`;
                clearTimeout(loadingTimeout);
                
                this.analytics = {
                    overview: {
                        total_tasks: 0,
                        completed_tasks: 0,
                        completion_rate: 0,
                        overdue_tasks: 0
                    },
                    completion_trend: [],
                    status_distribution: {},
                    priority_distribution: {},
                    category_distribution: []
                };
            } finally {
                this.loading = false;
            }
        },

        renderCharts() {
            this.renderCompletionChart();
            this.renderStatusChart();
            this.renderPriorityChart();
        },

        renderCompletionChart() {
            const ctx = document.getElementById('completionChart');
            if (!ctx || !this.analytics.completion_trend) return;

            if (this.completionChart) {
                this.completionChart.destroy();
            }

            const labels = this.analytics.completion_trend.map(item => 
                new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'Asia/Dhaka' })
            );
            const data = this.analytics.completion_trend.map(item => item.completed);

            this.completionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tasks Completed',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        },

        renderStatusChart() {
            const ctx = document.getElementById('statusChart');
            if (!ctx || !this.analytics.status_distribution) return;

            if (this.statusChart) {
                this.statusChart.destroy();
            }

            const statusLabels = Object.keys(this.analytics.status_distribution);
            const statusData = Object.values(this.analytics.status_distribution);
            const statusColors = {
                'todo': '#6B7280',
                'in_progress': '#3B82F6',
                'review': '#F59E0B',
                'done': '#10B981'
            };

            this.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: statusLabels.map(label => label.replace('_', ' ').toUpperCase()),
                    datasets: [{
                        data: statusData,
                        backgroundColor: statusLabels.map(label => statusColors[label] || '#6B7280')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        },

        renderPriorityChart() {
            const ctx = document.getElementById('priorityChart');
            if (!ctx || !this.analytics.priority_distribution) return;

            if (this.priorityChart) {
                this.priorityChart.destroy();
            }

            // Ensure all priority categories are shown
            const allPriorities = ['must', 'should', 'could', 'wont'];
            const priorityData = [];
            const priorityColors = {
                'must': '#DC2626',     // Red for Must Have
                'should': '#F59E0B',   // Orange for Should Have  
                'could': '#10B981',    // Green for Could Have
                'wont': '#6B7280'      // Gray for Won't Have
            };

            // Build data ensuring all categories are included
            allPriorities.forEach(priority => {
                priorityData.push(this.analytics.priority_distribution[priority] || 0);
            });

            this.priorityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allPriorities.map(label => label.toUpperCase()),
                    datasets: [{
                        data: priorityData,
                        backgroundColor: allPriorities.map(label => priorityColors[label]),
                        borderColor: allPriorities.map(label => priorityColors[label]),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label.toLowerCase();
                                    const value = context.raw;
                                    const priorityNames = {
                                        'must': 'Must Have',
                                        'should': 'Should Have',
                                        'could': 'Could Have',
                                        'wont': "Won't Have"
                                    };
                                    return `${priorityNames[label]}: ${value} task${value !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                stepSize: 1,
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : '';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    }
}
</script>
{% endblock %}
